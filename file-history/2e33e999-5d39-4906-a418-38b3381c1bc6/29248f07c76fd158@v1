import { ILogger } from "@generatezero/ports/logger";

import { LoggableClass } from "@/server/common/LoggableClass";
import {
  ITagRepository,
  TagInput
} from "../interfaces/TagRepository.interface";
import { TagDto } from "../models/Tag.model";
import { TagRepository } from "../repositories/Tag.repository";

/**
 * Manages tags
 */
export class TagService extends LoggableClass {
  constructor(
    logger: ILogger,
    private tagRepository: ITagRepository
  ) {
    super(logger, "TagService");
  }

  static build(dbUrl: string, logger: ILogger) {
    return new TagService(logger, new TagRepository(dbUrl, logger));
  }

  async getTags(searchTerm?: string): Promise<TagDto[]> {
    const tags = await this.tagRepository.getTags(searchTerm);
    return tags.sort((a, b) => a.name.localeCompare(b.name));
  }

  async checkNameDuplication(name: string): Promise<boolean> {
    const allTags = await this.getTags();
    const existingName = allTags.some((tag) => tag.name === name);

    return existingName;
  }

  async createTag(newTag: TagInput): Promise<TagDto> {
    return await this.tagRepository.createTag(newTag);
  }

  async updateTag(tagId: string, updatedTag: TagInput): Promise<TagDto> {
    return await this.tagRepository.updateTag(tagId, updatedTag);
  }

  async deleteTag(tagId: string): Promise<TagDto> {
    await this.tagRepository.removeAssociatedFacilitiesByTagId(tagId);
    await this.tagRepository.removeAssociatedUnitsByTagId(tagId);

    return await this.tagRepository.deleteTag(tagId);
  }
}
