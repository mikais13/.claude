# Code Review: Facility Creation Upon Upload and Linking to Organisation

## Summary

I've reviewed your implementation of facility creation during bulk upload and the facility-to-organisation linking. The overall architecture is solid with good separation of concerns (Parser → Service → Repository), but I found **5 issues** - one critical bug that will prevent facilities from being linked correctly, plus data loss issues.

### Quick Summary of Issues

| # | Severity | Issue | Impact |
|---|----------|-------|--------|
| 1 | Medium | Missing `stateProvince` field mapping | State data lost from CSV |
| 2 | Medium | Facility tags not associated | Facility tags lost from CSV |
| 3 | Medium | Facility tags not created | New facility-only tags not created |
| 4 | **Critical** | FacilityMap inversion bug | **No facility-org links created** |
| 5 | Low | Non-null assertion on tag lookup | Potential runtime error |

## Implementation Overview

Your flow works as follows:
1. **API Route** ([route.ts:15-136](apps/footprint/src/app/api/organisations/bulk/upload/route.ts#L15-L136)) receives CSV files
2. **Preparation Phase**: Parses and validates without DB changes
   - `organisationService.prepareOrganisationTemplate()` extracts `facilityMap` (org name → facility names)
   - `facilityService.prepareFacilityTemplate()` parses facilities and their tags
3. **Validation**: `validateFacilityMap()` ensures all referenced facilities exist
4. **Execution Phase**: Single transaction creates everything in `bulkUploadOrganisations()`

---

## Issues Found

### Issue 1: Missing `stateProvince` Field Mapping (Data Loss)

**Location**: [OrganisationRepository.ts:444-458](apps/footprint/src/server/modules/Organisation/repositories/OrganisationRepository.ts#L444-L458)

**Problem**: The `stateProvince` field parsed from CSV is never saved to the database.

```typescript
// Parser output (BulkFacilityUnit interface):
stateProvince?: string;  // ← Parsed from CSV

// But in bulkUploadOrganisations:
const facility = await tx.facility.create({
  data: {
    name: facilityUnit.name,
    address: facilityUnit.addressLine1,
    suburb: facilityUnit.addressLine2,  // addressLine2 mapped to suburb
    country: facilityUnit.country,
    postalCode: facilityUnit.postalCode,
    city: facilityUnit.city,
    // stateProvince is MISSING
  }
});
```

**Impact**: State/Province data from CSV uploads is silently discarded.

**Fix**: Add `state: facilityUnit.stateProvince` to the create data.

---

### Issue 2: Facility Tags Not Being Associated (Data Loss)

**Location**: [OrganisationRepository.ts:430-480](apps/footprint/src/server/modules/Organisation/repositories/OrganisationRepository.ts#L430-L480)

**Problem**: Facility tags are parsed and prepared, but never linked to facilities during bulk upload.

```typescript
// In prepareFacilityTemplate() - tags ARE prepared:
return {
  facilities: bulkFacilities,  // Each has tags: string[]
  existingTagMap,
  tagsToCreate  // Tags ready to create
};

// But in bulkUploadOrganisations():
// 1. Organisation tags ARE created (lines 358-365)
// 2. Organisation-tag associations ARE created (lines 419-427)
// 3. Facilities ARE created (lines 444-460)
// 4. Facility-tag associations are MISSING!
```

**Impact**: Facilities uploaded via bulk import will have no tags despite being specified in CSV.

**Fix**: After creating each facility, add tag associations similar to organisation tags.

---

### Issue 3: Facility Tags Not Created in Transaction

**Location**: [OrganisationRepository.ts:357-365](apps/footprint/src/server/modules/Organisation/repositories/OrganisationRepository.ts#L357-L365)

**Problem**: Only organisation tags from `tagsToCreate` are created. Facility tags from `processedFacilities.tagsToCreate` are never created.

```typescript
// Only creates organisation template tags:
if (tagsToCreate.length > 0) {
  const createdTags = await Promise.all(
    tagsToCreate.map((tag) => tx.tag.create({ data: tag }))
  );
}

// processedFacilities.tagsToCreate is never used!
```

**Impact**: If a facility tag doesn't already exist and isn't also an organisation tag, it won't be created.

**Fix**: Merge `processedFacilities.tagsToCreate` with `tagsToCreate` before creating tags.

---

### Issue 4: FacilityMap Inversion Logic (CRITICAL BUG)

**Location**: [OrganisationRepository.ts:463-478](apps/footprint/src/server/modules/Organisation/repositories/OrganisationRepository.ts#L463-L478)

**Problem**: The `facilityMap` is keyed by **organisation name** with **facility names** as values (built in [Organisation.service.ts:434-440](apps/footprint/src/server/modules/Organisation/services/Organisation.service.ts#L434-L440)), but the association loop treats it as the inverse.

```typescript
// facilityMap is built as Map<orgName, facilityNames[]>:
facilityMap.set(orgUnit.name, orgUnit.facilities);

// But the iteration treats it as Map<facilityName, orgNames[]>:
for (const [facilityName, orgNames] of facilityMap.entries()) {
  const facilityId = facilityIdMap.get(facilityName);  // ← Looking up org name in facility map!
  const orgIds = orgNames.map((orgName) => orgIdMap.get(orgName));  // ← Looking up facility names in org map!
}
```

**Impact**: This will create incorrect associations or fail silently:
- `facilityIdMap.get(orgName)` returns `undefined` (org name doesn't exist in facility map)
- The associations won't be created due to the `if (!facilityId)` guard

**Fix**: Invert the map to `Map<facilityName, orgNames[]>` before iterating, or restructure the loop.

---

### Issue 5: Potential Type Safety Issue with Tag Lookup

**Location**: [OrganisationRepository.ts:422-425](apps/footprint/src/server/modules/Organisation/repositories/OrganisationRepository.ts#L422-L425)

**Problem**: Non-null assertion (`!`) assumes tag always exists in map.

```typescript
data: orgUnit.tags.map((tagName) => ({
  organisationUnitId: organisation.id,
  tagId: tagMap.get(tagName)!  // ← Could be undefined
}))
```

**Impact**: If a tag isn't in the map (edge case), this would insert `undefined` as tagId.

**Fix**: Add validation or filter out undefined values.

---

## Minor Observations

### Field Naming Inconsistency
- Parser uses: `addressLine1`, `addressLine2`, `stateProvince`
- Repository maps to: `address`, `suburb`, (missing state)
- Individual create uses: `addressLine`, `addressLineAdditional`, `state`

This inconsistency makes the code harder to maintain.

### Response Feedback
The API returns only `createdCount` for organisations. Consider adding:
- `facilitiesCreatedCount`
- `tagsCreatedCount`

---

## Recommended Fixes

1. **Add stateProvince mapping** in bulk upload
2. **Create facility tags** by merging with org tags before creation
3. **Link facility tags** to facilities after facility creation
4. **Fix facilityMap iteration** - invert the map or restructure the loop
5. **Add null checks** for tag lookups

---

## Files to Modify

| File | Changes |
|------|---------|
| [OrganisationRepository.ts](apps/footprint/src/server/modules/Organisation/repositories/OrganisationRepository.ts) | Fix issues 1-5 in `bulkUploadOrganisations()` |
| [OrganisationRepository.interface.ts](apps/footprint/src/server/modules/Organisation/interfaces/OrganisationRepository.interface.ts) | Update `BulkOrganisationUploadInput` if needed |
