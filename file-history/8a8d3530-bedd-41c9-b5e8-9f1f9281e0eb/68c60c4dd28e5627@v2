# Test Plan: Upload Organisation with Facilities

## Overview

The upload organisation functionality now supports:
1. **Organisation creation** from CSV with hierarchy, tags, and date ranges
2. **Facilities creation** from optional separate CSV with addresses and tags
3. **Linking** organisations to facilities via `facilityMap`
4. **Tag handling** - shared tag creation for both orgs and facilities

---

## Current Test Coverage

The existing `UploadOrganisation.test.ts` covers:
- ✅ Organisation hierarchy creation
- ✅ Tag creation and assignment to orgs
- ✅ Parent org info (FY start, reporting standard, consolidation approach)
- ✅ Error when organisations already exist
- ✅ Financial years and quarters generation
- ✅ Tags not created if already exist

**Gaps to address:**
- ❌ Facility creation during bulk upload
- ❌ Facility-to-organisation linking
- ❌ Facility tag assignment
- ❌ Shared facility detection (`isSharedFacility`)
- ❌ `validateFacilityMap()` error handling
- ❌ Combined org + facility tag deduplication

---

## Test Plan

### 1. Unit Tests - Organisation Service (`UploadOrganisation.test.ts`)

#### 1.1 Facility Creation Tests

```typescript
describe('uploadOrganisationTemplate with facilities', () => {
  it('should pass facilities to bulk upload when facility template provided', async () => {
    // Arrange: Prepare org data + facility data
    // Act: Call uploadOrganisationTemplate with facilities
    // Assert: bulkUploadOrganisations called with facilities array
  });

  it('should pass facility map linking orgs to facilities', async () => {
    // Arrange: Org CSV with "Facilities" column containing facility names
    // Act: Prepare + upload
    // Assert: facilityMap correctly maps org names to facility names
  });

  it('should handle organisations without facilities', async () => {
    // Arrange: Some orgs have facilities, some don't
    // Act: Prepare + upload
    // Assert: facilityMap only contains orgs with facilities
  });
});
```

#### 1.2 Tag Handling Tests

```typescript
describe('tag handling with facilities', () => {
  it('should merge org tags and facility tags for creation', async () => {
    // Arrange: Org tags = ['TagA', 'TagB'], Facility tags = ['TagB', 'TagC']
    // Act: Upload both
    // Assert: Combined unique tags created = ['TagA', 'TagB', 'TagC']
  });

  it('should pass facility tags to bulk upload', async () => {
    // Assert: facilityTagsToCreate and facilityExistingTagMap passed
  });

  it('should handle pre-existing tags shared between orgs and facilities', async () => {
    // Arrange: 'SharedTag' exists in DB, used by both org and facility
    // Assert: Not duplicated in tagsToCreate
  });
});
```

#### 1.3 Shared Facility Tests

```typescript
describe('shared facility detection', () => {
  it('should mark facility as shared when linked to multiple orgs', async () => {
    // Arrange: Facility "HQ" linked to both "Org A" and "Org B"
    // Assert: isSharedFacility = true for "HQ"
  });

  it('should not mark facility as shared when linked to single org', async () => {
    // Arrange: Facility "Branch 1" linked only to "Org A"
    // Assert: isSharedFacility = false
  });
});
```

---

### 2. Unit Tests - Facility Helpers

#### 2.1 `validateFacilityMap()` Tests

Location: Create `apps/footprint/src/server/modules/Organisation/helpers/__tests__/Facility.helpers.test.ts`

```typescript
describe('validateFacilityMap', () => {
  it('should pass when all facilities in map exist', () => {
    const facilityMap = new Map([['Org A', ['Facility 1', 'Facility 2']]]);
    const facilities = [{ name: 'Facility 1' }, { name: 'Facility 2' }];
    expect(() => validateFacilityMap(facilityMap, facilities)).not.toThrow();
  });

  it('should throw when facility in map does not exist', () => {
    const facilityMap = new Map([['Org A', ['Missing Facility']]]);
    const facilities = [{ name: 'Facility 1' }];
    expect(() => validateFacilityMap(facilityMap, facilities)).toThrow(FacilityServiceError);
  });

  it('should list all missing facilities in error message', () => {
    const facilityMap = new Map([['Org A', ['Missing 1', 'Missing 2']]]);
    const facilities = [];
    expect(() => validateFacilityMap(facilityMap, facilities)).toThrow(/Missing 1.*Missing 2/);
  });

  it('should pass with empty facility map', () => {
    const facilityMap = new Map();
    const facilities = [{ name: 'Facility 1' }];
    expect(() => validateFacilityMap(facilityMap, facilities)).not.toThrow();
  });
});
```

---

### 3. Unit Tests - Repository (`OrganisationRepository.test.ts`)

Test the `bulkUploadOrganisations` transaction logic:

```typescript
describe('bulkUploadOrganisations with facilities', () => {
  it('should create facilities within transaction', async () => {
    // Assert: facility.create called for each facility
  });

  it('should create organisationFacility associations', async () => {
    // Assert: organisationFacility.create called with correct org/facility IDs
  });

  it('should create facilityTag associations', async () => {
    // Assert: facilityTag.createMany called with facility-tag pairs
  });

  it('should set isSharedFacility based on org count', async () => {
    // Arrange: Facility linked to 2 orgs
    // Assert: facility.create called with isSharedFacility: true
  });

  it('should rollback all on facility creation failure', async () => {
    // Arrange: Mock facility.create to throw
    // Assert: Transaction rolls back, no orgs created
  });
});
```

---

### 4. Integration Tests - API Route

Location: `apps/footprint/src/app/api/organisations/bulk/upload/__tests__/route.test.ts`

```typescript
describe('POST /api/organisations/bulk/upload', () => {
  describe('with facilities file', () => {
    it('should create orgs and facilities from both CSVs', async () => {
      // Arrange: FormData with both CSV files
      // Act: POST request
      // Assert: 200 response with created count
    });

    it('should return 400 when facility in org CSV not in facilities CSV', async () => {
      // Arrange: Org CSV references "Unknown Facility"
      // Assert: 400 with error listing missing facilities
    });

    it('should return 400 when facilities file is not CSV', async () => {
      // Assert: "Invalid file type" error
    });
  });

  describe('without facilities file', () => {
    it('should create orgs only when no facilities file provided', async () => {
      // Assert: Success, no facilities created
    });

    it('should fail if org CSV references facilities but no file provided', async () => {
      // Assert: Error about missing facilities
    });
  });
});
```

---

### 5. CSV Parser Tests

#### 5.1 Organisation Parser - Facility Column

Location: `apps/footprint/src/server/modules/Organisation/parsers/__tests__/OrganisationTemplateCsvParser.test.ts`

```typescript
describe('facility parsing', () => {
  it('should parse comma-separated facilities from Facilities column', () => {
    const csv = `Name,Hierarchy,Facilities,...
Root,,Facility A, Facility B,...`;
    const result = parser.parseOrganisationTemplateBuffer(buffer);
    expect(result.organisationUnits[0].facilities).toEqual(['Facility A', 'Facility B']);
  });

  it('should handle empty Facilities column', () => {
    // Assert: facilities = []
  });

  it('should trim whitespace from facility names', () => {
    // Input: "  Facility A  ,  Facility B  "
    // Assert: ['Facility A', 'Facility B']
  });
});
```

#### 5.2 Facilities Parser Tests

Location: `apps/footprint/src/server/modules/Organisation/parsers/__tests__/FacilitiesTemplateCsvParser.test.ts`

```typescript
describe('FacilitiesTemplateCsvParser', () => {
  it('should parse all address fields', () => {
    // Assert: address, addressLine2, region, postalCode, city, country
  });

  it('should parse facility tags', () => {
    // Assert: tags array populated
  });

  it('should skip rows with missing name', () => {
    // Assert: Row skipped, warning logged
  });

  it('should handle optional fields as empty strings', () => {
    // Assert: Missing address fields default to empty
  });
});
```

---

### 6. E2E Tests (Playwright)

Location: `apps/footprint/e2e/organisation-upload.spec.ts`

```typescript
test.describe('Organisation Upload', () => {
  test('should upload organisations with facilities', async ({ page }) => {
    // 1. Navigate to Settings > Organisation
    // 2. Click "Upload Organisation"
    // 3. Upload org CSV file
    // 4. Upload facilities CSV file
    // 5. Fill form fields (FY start, reporting standard, consolidation)
    // 6. Submit
    // 7. Verify success toast
    // 8. Verify organisations appear in list
    // 9. Verify facilities linked to correct orgs
  });

  test('should show error for invalid facility references', async ({ page }) => {
    // Upload org CSV with facilities not in facilities CSV
    // Verify error message displayed
  });

  test('should upload organisations without facilities', async ({ page }) => {
    // Upload only org CSV (no facilities file)
    // Verify success
  });
});
```

---

### 7. Manual Testing Checklist

#### 7.1 Happy Path
- [ ] Upload org CSV only (no facilities) - orgs created
- [ ] Upload org CSV + facilities CSV - both created
- [ ] Verify org-facility links in database
- [ ] Verify tags created for both orgs and facilities
- [ ] Verify shared facility flag when facility linked to multiple orgs

#### 7.2 Error Cases
- [ ] Missing required columns in org CSV
- [ ] Missing required columns in facilities CSV
- [ ] Facility referenced in org CSV doesn't exist in facilities CSV
- [ ] Duplicate organisation names
- [ ] Duplicate facility names
- [ ] Invalid date formats
- [ ] Circular hierarchy references
- [ ] Non-CSV file upload

#### 7.3 Edge Cases
- [ ] Facility linked to only one org (isSharedFacility = false)
- [ ] Facility linked to multiple orgs (isSharedFacility = true)
- [ ] Tags shared between orgs and facilities (no duplicates created)
- [ ] Pre-existing tags in database (not recreated)
- [ ] Empty facilities column in org CSV
- [ ] Empty tags column in both CSVs

---

## Test Data Templates

### Organisation CSV
```csv
Name,Description,Hierarchy,Facilities,Reporting Start Date,Reporting End Date,Tags
Root Org,Root organisation,,"Facility A, Facility B",01/01/2024,31/12/2024,"Tag1, Tag2"
Child Org 1,First child,Root Org,Facility A,01/01/2024,31/12/2024,Tag1
Child Org 2,Second child,Root Org,Facility B,01/01/2024,31/12/2024,Tag2
```

### Facilities CSV
```csv
Name,Description,Address Line 1,Address Line 2,State/Province,Postal Code,City,Country,Tags
Facility A,Main office,123 Main St,,NSW,2000,Sydney,Australia,"FacilityTag1, SharedTag"
Facility B,Branch office,456 Branch Rd,Suite 100,VIC,3000,Melbourne,Australia,"FacilityTag2, SharedTag"
```

---

## Priority Order

1. **High Priority** - Unit tests for `validateFacilityMap()` helper
2. **High Priority** - Service tests for facility + org linking
3. **Medium Priority** - Repository transaction tests
4. **Medium Priority** - API route integration tests
5. **Lower Priority** - E2E tests (manual testing covers this initially)

---

## Files to Create/Modify

| File | Action |
|------|--------|
| `Organisation/__tests__/UploadOrganisation.test.ts` | Add facility-related tests |
| `Organisation/helpers/__tests__/Facility.helpers.test.ts` | Create new test file |
| `Organisation/repositories/__tests__/OrganisationRepository.test.ts` | Add bulk upload tests |
| `api/organisations/bulk/upload/__tests__/route.test.ts` | Create API tests |
| `parsers/__tests__/FacilitiesTemplateCsvParser.test.ts` | Verify/extend coverage |
